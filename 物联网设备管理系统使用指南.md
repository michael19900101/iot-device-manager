# 物联网设备管理系统使用指南

## 系统概述

本系统是一个基于Netty的物联网设备管理平台，支持设备连接、状态监控、实时通知等功能。系统包含后端服务器和Vue3前端界面。

## 系统架构

```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│   前端界面      │ ←──────────────→ │   WebSocket     │
│   (Vue3)       │                  │   服务器        │
└─────────────────┘                  └─────────────────┘
                                              │
                                              │ TCP
                                              ▼
                                    ┌─────────────────┐
                                    │   物联网设备    │
                                    │   (TCP客户端)   │
                                    └─────────────────┘
```

## 快速开始

### 1. 环境准备

#### 后端环境
- Java 11+
- Maven 3.6+

#### 前端环境
- Node.js 16+
- npm 8+

### 2. 启动系统

#### 步骤1: 启动后端服务器

```bash
# 编译项目
mvn clean compile

# 启动物联网服务器
mvn compile
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.server.IoTApplication 8888 8889
```

服务器将启动：
- TCP服务器：端口8888（设备连接）
- WebSocket服务器：端口8889（前端通信）

#### 步骤2: 启动前端界面

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动前端服务器
npm run dev
```

前端界面将在 http://localhost:3000 启动。

#### 步骤3: 测试设备连接

```bash
# 启动设备模拟器
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.test.IoTDeviceSimulator localhost 8888 "温度传感器" "传感器"
```

### 3. 系统功能

#### 设备管理
- **设备注册**: 设备连接时自动注册
- **状态监控**: 实时显示设备在线/离线状态
- **心跳检测**: 自动检测设备心跳，超时自动下线
- **数据上报**: 接收设备上报的数据

#### 前端界面
- **设备统计**: 显示设备总数、在线数量、离线数量
- **设备筛选**: 支持按状态、类型、名称筛选
- **实时更新**: WebSocket实时接收设备状态变更
- **设备详情**: 查看设备详细信息
- **状态通知**: 设备上线下线实时通知

## 设备通信协议

### 消息格式
所有消息使用 `|` 分隔符，格式为：`命令|参数1|参数2|...`

### 支持的命令

#### 1. 设备注册
```
REGISTER|设备ID|设备名称|设备类型
```
示例：
```
REGISTER|ABC123|温度传感器|传感器
```

#### 2. 心跳消息
```
HEARTBEAT|设备ID
```
示例：
```
HEARTBEAT|ABC123
```

#### 3. 数据上报
```
DATA|数据内容
```
示例：
```
DATA|{"temperature":25.6,"humidity":60.2}
```

### 服务器响应

#### 注册成功
```
注册成功！设备ID: ABC123
```

#### 心跳确认
```
HEARTBEAT_OK
```

#### 数据接收确认
```
DATA_RECEIVED
```

## 设备模拟器使用

### 基本用法
```bash
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.test.IoTDeviceSimulator [服务器地址] [端口] [设备名称] [设备类型]
```

### 示例
```bash
# 连接本地服务器
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.test.IoTDeviceSimulator localhost 8888 "温度传感器" "传感器"

# 连接远程服务器
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.test.IoTDeviceSimulator 192.168.1.100 8888 "湿度传感器" "传感器"
```

### 模拟器功能
- 自动生成设备ID（8位随机字符串）
- 自动注册设备
- 定时发送心跳（30秒间隔）
- 定时上报数据（10秒间隔）
- 模拟传感器数据（温度20-30°C，湿度40-70%）
- 支持PING/PONG响应
- 自动重连功能

## 前端界面操作

### 1. 设备筛选
- **状态筛选**: 选择"在线"或"离线"状态
- **类型筛选**: 选择设备类型（传感器、控制器、摄像头）
- **名称筛选**: 输入设备名称关键词

### 2. 设备详情
点击设备列表中的"查看"按钮，可以查看设备的详细信息：
- 设备ID
- 设备名称
- 设备类型
- 连接状态
- IP地址和端口
- 连接时间
- 最后心跳时间
- 断开时间（如果已断开）

### 3. 实时通知
当设备状态发生变化时，系统会显示通知：
- 设备上线：绿色通知
- 设备下线：黄色通知

## 配置说明

### 端口配置
可以在启动时指定端口：
```bash
# 指定TCP端口和WebSocket端口
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.server.IoTApplication 8888 8889
```

### 心跳配置
在 `IoTDeviceHandler.java` 中可以修改心跳配置：
```java
// 空闲状态检测：60秒读空闲，30秒写空闲
pipeline.addLast(new IdleStateHandler(60, 30, 0, TimeUnit.SECONDS));
```

### 前端配置
在 `frontend/vite.config.js` 中可以修改前端配置：
```javascript
export default defineConfig({
  server: {
    port: 3000,  // 前端端口
    proxy: {
      '/ws': {
        target: 'ws://localhost:8889',  // WebSocket服务器地址
        ws: true
      }
    }
  }
})
```

## 故障排除

### 常见问题

#### 1. 服务器启动失败
**问题**: 端口被占用
**解决**: 
```bash
# 查看端口占用
lsof -i :8888
lsof -i :8889

# 杀死占用进程
kill -9 <进程ID>

# 或者使用其他端口
java -cp "target/classes:$(mvn dependency:build-classpath -Dmdep.outputFile=/dev/stdout -q)" com.michael.iot.server.IoTApplication 9999 9998
```

#### 2. 前端无法连接WebSocket
**问题**: WebSocket连接失败
**解决**:
- 检查后端服务器是否启动
- 检查防火墙设置
- 确认WebSocket端口是否开放
- 检查浏览器控制台错误信息

#### 3. 设备连接失败
**问题**: 设备无法连接到服务器
**解决**:
- 检查TCP服务器是否启动
- 确认网络连接
- 检查服务器地址和端口是否正确
- 查看服务器日志

#### 4. 前端依赖安装失败
**问题**: npm install失败
**解决**:
```bash
# 清除npm缓存
npm cache clean --force

# 删除node_modules重新安装
rm -rf node_modules package-lock.json
npm install
```

### 日志查看

#### 服务器日志
```bash
# 查看实时日志
tail -f logs/netty-server.log

# 查看特定日期的日志
cat logs/netty-server.2025-08-07.log
```

#### 前端日志
在浏览器开发者工具中查看Console和Network标签页。

## 扩展开发

### 添加新设备类型
1. 在 `DeviceInfo.java` 中定义新的设备类型
2. 在前端 `App.vue` 中添加设备类型选项
3. 在设备模拟器中添加相应的模拟逻辑

### 添加新功能
- 设备命令下发
- 设备数据存储
- 设备分组管理
- 告警规则配置
- 历史数据查询

### 性能优化
- 增加连接池
- 优化消息处理
- 添加缓存机制
- 实现负载均衡

## 技术支持

如果遇到问题，请：
1. 查看日志文件
2. 检查系统配置
3. 参考故障排除部分
4. 查看项目文档

## 更新日志

### v1.0.0
- 初始版本发布
- 支持设备连接和状态监控
- 实现实时通知功能
- 提供Vue3前端界面






